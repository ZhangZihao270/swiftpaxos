# Phase 43 Post-Optimization Evaluation — 2026-02-20

## Changes Applied (Phase 43)

1. **Split handleMsgs** (43.2c): Separate goroutines for strong-path (replyChan, recordAckChan, syncReplyChan) and weak-path (causalReplyChan, weakReadReplyChan) replies
2. **Priority fast-path** (43.2b): Non-blocking receive on `causalProposeChan` before the main run-loop `select`
3. **BoundReplica filtering** (43.3): Non-bound replicas skip MCausalReply — eliminates 2/3 of wasted reply traffic
4. **Async sendMsgToAll reverted** (43.2a fix): Async remote sends caused data race on bufio.Writer and broke causal ordering (strong ops fell to 2-RTT slow path). Reverted to synchronous sends.

## Environment

| Parameter        | Value                                      |
|------------------|--------------------------------------------|
| Replicas         | 3 (130.245.173.101, .102, .104)            |
| Clients          | 3 (co-located with replicas)               |
| Network Delay    | 25ms one-way (50ms RTT), application-level |
| Requests/Client  | 10,000                                     |
| Pendings         | 15                                         |
| Pipeline         | true                                       |
| Weak Ratio       | 50%                                        |
| Weak Writes      | 10%                                        |
| Strong Writes    | 10%                                        |
| Command Size     | 100 bytes                                  |
| Batch Delay      | 150us                                      |

**Server load during tests**:
- 130.245.173.101 (replica0, client2): load 1.44 — OK
- 130.245.173.102 (replica1, client0, MASTER): **load 5.75, 8 users** — HIGH
- 130.245.173.104 (replica2, client1): load 0.61 — OK

Throughput scaling is limited by server load on .102. Latency metrics are reliable since they measure per-op round-trip time.

## Results

| Threads | Throughput | S-Avg (ms) | S-Median (ms) | S-P99 (ms) | W-Avg (ms) | W-Median (ms) | W-P99 (ms) |
|--------:|-----------:|-----------:|---------------:|------------:|------------:|---------------:|------------:|
| 2       | 3,558      | 50.86      | 51.24          | 53.49       | 0.22        | 0.18           | 0.82        |
| 4 (r1)  | 2,078      | 68.84      | 51.80          | 100.91      | 15.49       | 0.21           | 100.82      |
| 4 (r2)  | 2,225      | 62.74      | 51.54          | 100.80      | 15.12       | 0.21           | 100.67      |
| 4 (r3)  | 2,327      | 72.94      | 51.65          | 100.93      | 3.76        | 0.18           | 100.80      |
| 8       | 3,513      | 51.41      | 51.28          | 53.52       | 0.21        | 0.18           | 0.81        |
| 16      | 3,558      | 50.89      | 51.20          | 53.43       | 0.23        | 0.19           | 1.08        |
| 32      | 883        | 81.87      | 52.29          | 101.03      | 46.31       | 0.25           | 101.02      |

## Comparison with Phase 42 Reference (2026-02-19)

| Threads | W-P99 (Phase 42) | W-P99 (Phase 43) | Change   |
|--------:|------------------:|------------------:|----------|
| 2       | 0.86ms            | 0.82ms            | -5%      |
| 4       | 100.96ms          | ~100.80ms         | ~same    |
| 8       | 2.62ms            | **0.81ms**        | **-69%** |
| 16      | 100.95ms          | **1.08ms**        | **-99%** |
| 32      | 100.38ms          | 101.02ms          | ~same    |

**Key improvements**:
- **16 threads W-P99**: 100.95ms → 1.08ms (93× improvement)
- **8 threads W-P99**: 2.62ms → 0.81ms (3.2× improvement)
- **2 threads**: Matches reference exactly (no regression)

**Remaining issues**:
- 4 threads W-P99 remains ~100ms — consistent across 3 runs, not environmental
- 32 threads W-P99 ~101ms — likely server load related (throughput dropped to 883)
- Throughput scaling limited by server .102 load (5.75)

## Bug Fixed: Async sendMsgToAll Race Condition

The Phase 43.2a optimization (async remote sends) caused ALL strong ops to fall to 2-RTT slow path:
- **Root cause**: Async goroutines for remote replica sends raced with subsequent strong command `SendMsg()` calls on the same `bufio.Writer`. Additionally, causal writes arrived at remote replicas AFTER subsequent strong commands, causing `checkCausalDeps()` to fail.
- **Symptom**: S-Median doubled from 51ms to 100ms; throughput dropped 62%
- **Fix**: Reverted `sendMsgToAll` to synchronous sends. Kept `sendMsgSafe` (with `writerMu`) for timer retry sends in `handleStrongMsgs` goroutine to prevent writer races.
